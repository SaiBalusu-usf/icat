<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CricClubs Dynamic Cricket Scoreboard</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f5f9fa;
      color: #333;
      font-size: 14px;
    }
    .score-banner {
      background: linear-gradient(to right, #4ac1c7, #2a6d80);
      border-radius: 4px;
      margin-bottom: 15px;
      color: white;
      padding: 20px;
    }
    .teams-header {
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: bold;
      text-align: center;
    }
    .score-display {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 18px;
      text-align: center;
    }
    .tables-container {
      display: flex;
      gap: 0;
      align-items: stretch;
    }
    .table-section { flex: 1; }
    .info-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 4px;
      overflow: hidden;
      background-color: transparent;
    }
    .info-table th, .info-table td {
      border: 1px solid #e3f2f5;
      padding: 8px;
      text-align: left;
    }
    .info-table th {
      background-color: transparent;
      color: #ffffff;
    }
    .info-table tr:nth-child(even) { background-color: rgba(255,255,255,0.09);}
    .striker-indicator { font-weight: bold; color: #2a6d80; margin-right: 5px; }
    .loading { text-align: center; padding: 20px; font-style: italic; color: #777;}
    .controls {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 20px; padding: 10px;
      background: linear-gradient(to right, #f5f9fa, #e3f2f5);
      border-radius: 4px;
    }
    .match-id-control { display: flex; gap: 10px; align-items: center;}
    input[type="number"] {
      padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; width: 80px;
    }
    button {
      background: linear-gradient(to right, #4ac1c7, #3a8f99);
      color: white; border: none; padding: 6px 12px; border-radius: 4px;
      cursor: pointer; font-weight: bold; transition: all 0.2s ease;
    }
    button:hover { background: linear-gradient(to right, #3a8f99, #2a6d80);}
    .auto-refresh { display: flex; align-items: center; gap: 10px;}
    @media (max-width: 768px) {
      .tables-container { flex-direction: column;}
      .controls { flex-direction: column; gap: 10px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="scoreContent" class="scores-panel">
      <div id="loading" class="loading">Loading match details...</div>
    </div>
    <div class="controls">
      <div class="match-id-control">
        <label for="clubId">Club ID:</label>
        <input type="number" id="clubId" value="862" min="1">
        <label for="matchId">Match ID:</label>
        <input type="number" id="matchId" value="734" min="1">
        <button id="loadMatchBtn">Load Match</button>
      </div>
      <div class="auto-refresh">
        <input type="checkbox" id="autoRefresh">
        <label for="autoRefresh">Auto-refresh every 10 seconds</label>
      </div>
    </div>
  </div>
  <script>
    let clubId = 862;
    let matchId = 734;
    let autoRefreshInterval = null;

    // Main entry: load match and render scoreboard for latest innings
    async function loadMatchData() {
      clubId = document.getElementById('clubId').value;
      matchId = document.getElementById('matchId').value;
      document.getElementById('loading').style.display = '';
      document.getElementById('scoreContent').innerHTML =
        '<div id="loading" class="loading">Loading match details...</div>';

      try {
        // CricClubs does not offer public CORS, so you must use a CORS proxy if needed.
        // For demo/testing, this will only work if the browser is CORS-permissive (or use server-side/proxy).
        const url = `https://cricclubs.com/FT20/fullScorecard.do?matchId=734&clubId=862`;
        const response = await fetch(url, { mode: 'cors', credentials: 'omit' });

        if (!response.ok) throw new Error('Could not fetch scorecard: ' + response.status);

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Parse all innings from the page
        const allInnings = parseAllInnings(doc);

        // Show the latest (second) innings if present, else first
        let toShow = allInnings.length > 1 ? allInnings[1] : allInnings[0];

        // If both innings are over, prefer second; if only one, just show it.
        updateUI(toShow);

      } catch (error) {
        document.getElementById('scoreContent').innerHTML =
          `<div class="loading">Failed to load data: ${error.message}</div>`;
      }
    }

    // Parse all innings from the CricClubs HTML
    function parseAllInnings(doc) {
      const innings = [];
      // Each innings is in a div with class "scorecard-section" or "col-lg-12"
      const inningsSections = Array.from(doc.querySelectorAll('.scorecard-section, .col-lg-12'));
      inningsSections.forEach(section => {
        // Find batting/bowling team names (typically in h5, h4 or strong tags in section)
        let header = section.querySelector('h4, h5, strong');
        let teamTitle = header ? header.textContent.trim() : '';
        // Get score (runs/wickets/overs)
        let score = '';
        let overs = '';
        const scoreElem = section.querySelector('.score-title, .score, .card-title');
        if (scoreElem) {
          let txt = scoreElem.textContent.replace(/\s+/g, ' ');
          let match = txt.match(/(\d+\/\d+)\s*\(([\d\.]+)\s*overs?\)/);
          if (match) {
            score = match[1];
            overs = `${match[2]} ov`;
          }
        }
        // Fallback: sometimes score is in header
        if (!score && teamTitle) {
          let m = teamTitle.match(/(\d+\/\d+)/);
          if (m) score = m[1];
        }

        // Find batting table: has Batter|R|B or similar headers
        let battingTable = null, bowlTable = null;
        const tables = Array.from(section.querySelectorAll('table'));
        for (let t of tables) {
          let ths = Array.from(t.querySelectorAll('th')).map(x => x.textContent);
          if (ths.some(h => /batter|batsman|r|b|4s|6s|sr/i.test(h))) battingTable = t;
          if (ths.some(h => /bowler|o|w|econ/i.test(h))) bowlTable = t;
        }

        // Get batsmen (current or last two if finished)
        let batsmen = [];
        if (battingTable) {
          let trs = Array.from(battingTable.querySelectorAll('tbody tr'));
          for (let tr of trs) {
            let tds = Array.from(tr.querySelectorAll('td'));
            if (tds.length >= 6) {
              let name = tds[0].textContent.trim();
              if (!name || name === 'Extras') continue;
              batsmen.push({
                name,
                runs: tds[2].textContent.trim(),
                balls: tds[3].textContent.trim(),
                isStriker: /bold|not\s*out/i.test(tds[1].textContent) || false
              });
            }
          }
          // Show last 2 (typically current) or last two who batted if over
          batsmen = batsmen.slice(-2).map((b, i) => ({...b, isStriker: i === 0}));
        }

        // Get current bowler: first from bowling table, if exists
        let bowler = { name: '-', overs: '-', maidens: '-', runs: '-', wickets: '-', economy: '-' };
        if (bowlTable) {
          let btr = bowlTable.querySelector('tbody tr');
          if (btr) {
            let btds = Array.from(btr.querySelectorAll('td'));
            if (btds.length >= 6) {
              bowler = {
                name: btds[0].textContent.trim(),
                overs: btds[1].textContent.trim(),
                maidens: btds[2].textContent.trim(),
                runs: btds[3].textContent.trim(),
                wickets: btds[4].textContent.trim(),
                economy: btds[5].textContent.trim()
              };
            }
          }
        }

        // Add innings only if team info and at least partial score is available
        if (teamTitle && (score || batsmen.length > 0)) {
          // Try to split "TEAM X Innings" or "TEAM X 2nd Innings" for display
          let [battingTeam, inningsDesc] = teamTitle.split(/Innings|1st|2nd/i);
          innings.push({
            battingTeam: battingTeam ? battingTeam.trim().replace(/[^a-zA-Z0-9 ]/g, '') : '',
            inningsDesc: inningsDesc ? inningsDesc.trim() : '',
            score: score || '0/0',
            overs: overs || '',
            batsmen,
            bowler
          });
        }
      });
      // If nothing found, fallback to demo data
      if (!innings.length) {
        innings.push({
          battingTeam: "ICAT",
          inningsDesc: "",
          score: "6/0",
          overs: "1.0 /20 ov",
          batsmen: [
            { name: "Ashwath", runs: "4", balls: "6", isStriker: true },
            { name: "Kanwal", runs: "2", balls: "0", isStriker: false }
          ],
          bowler: { name: "Rohit Singh", overs: "1.0", maidens: "0", runs: "6", wickets: "0", economy: "6.00" }
        });
      }
      return innings;
    }

    // Update the page with current/last innings
    function updateUI(inn) {
      const { battingTeam, inningsDesc, score, overs, batsmen, bowler } = inn;
      // Find both batsmen (or placeholders)
      const [striker, nonStriker] = batsmen.length >= 2
        ? batsmen
        : [{ name: "?", runs: "?", balls: "?", isStriker: true }, { name: "?", runs: "?", balls: "?", isStriker: false }];
      // Calculate strike rate
      function sr(r, b) { return (b && +b !== 0) ? ((+r / +b) * 100).toFixed(2) : '0.00'; }
      // Build HTML
      document.getElementById('scoreContent').innerHTML = `
        <div class="score-banner">
          <div class="teams-header">${battingTeam} ${inningsDesc ? `(${inningsDesc})` : ''}</div>
          <div class="score-display">${score}${overs ? ` (${overs})` : ''}</div>
          <div class="tables-container">
            <div class="table-section">
              <table class="info-table">
                <thead>
                  <tr><th>Batter</th><th>Runs</th><th>Balls</th><th>SR</th></tr>
                </thead>
                <tbody>
                  ${batsmen.map(b => `
                    <tr>
                      <td>${b.isStriker ? '<span class="striker-indicator">*</span>' : ''}${b.name}</td>
                      <td>${b.runs}</td><td>${b.balls}</td><td>${sr(b.runs, b.balls)}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>
            <div class="table-section">
              <table class="info-table">
                <thead>
                  <tr><th>Bowler</th><th>O</th><th>M</th><th>R</th><th>W</th><th>Econ</th></tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${bowler.name}</td>
                    <td>${bowler.overs}</td>
                    <td>${bowler.maidens}</td>
                    <td>${bowler.runs}</td>
                    <td>${bowler.wickets}</td>
                    <td>${bowler.economy}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // Setup event listeners
    document.getElementById('loadMatchBtn').onclick = function() {
      loadMatchData();
    };
    document.getElementById('clubId').onkeypress = function(e) {
      if (e.key === 'Enter') loadMatchData();
    };
    document.getElementById('matchId').onkeypress = function(e) {
      if (e.key === 'Enter') loadMatchData();
    };
    document.getElementById('autoRefresh').onchange = function() {
      if (this.checked) {
        autoRefreshInterval = setInterval(loadMatchData, 10000);
      } else {
        clearInterval(autoRefreshInterval);
      }
    };
    // Initial load
    window.onload = loadMatchData;
  </script>
</body>
</html>
